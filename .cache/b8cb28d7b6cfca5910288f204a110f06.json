{"dependencies":[{"name":"superagent","loc":{"line":1,"column":22}},{"name":"es6-promise","loc":{"line":2,"column":22}},{"name":"./get-base-url","loc":{"line":3,"column":25}},{"name":"./http-header-safe-json","loc":{"line":4,"column":33}}],"generated":{"js":"var request = require('superagent');\nvar Promise = require('es6-promise').Promise;\nvar getBaseURL = require('./get-base-url');\nvar httpHeaderSafeJson = require('./http-header-safe-json');\n\nvar buildCustomError;\nvar downloadRequest;\nvar nodeBinaryParser;\n\n// Register a handler that will instruct superagent how to parse the response\nrequest.parse['application/octect-stream'] = function (obj) {\n  return obj;\n};\n\n// This doesn't match what was spec'd in paper doc yet\nbuildCustomError = function (error, response) {\n  return {\n    status: error.status,\n    error: (response ? response.text : null) || error.toString(),\n    response: response\n  };\n};\n\nnodeBinaryParser = function (res, done) {\n  res.text = '';\n  res.setEncoding('binary');\n  res.on('data', function (chunk) { res.text += chunk; });\n  res.on('end', function () {\n    done();\n  });\n};\n\ndownloadRequest = function (path, args, auth, host, accessToken, selectUser) {\n  if (auth !== 'user') {\n    throw new Error('Unexpected auth type: ' + auth);\n  }\n\n  var promiseFunction = function (resolve, reject) {\n    var apiRequest;\n\n    function success(data) {\n      if (resolve) {\n        resolve(data);\n      }\n    }\n\n    function failure(error) {\n      if (reject) {\n        reject(error);\n      }\n    }\n\n    function responseHandler(error, response) {\n      var data;\n      if (error) {\n        failure(buildCustomError(error, response));\n      } else {\n        // In the browser, the file is passed as a blob and in node the file is\n        // passed as a string of binary data.\n        data = JSON.parse(response.headers['dropbox-api-result']);\n        if (response.xhr) {\n          data.fileBlob = response.xhr.response;\n        } else {\n          data.fileBinary = response.res.text;\n        }\n        success(data);\n      }\n    }\n\n    apiRequest = request.post(getBaseURL(host) + path)\n      .set('Authorization', 'Bearer ' + accessToken)\n      .set('Dropbox-API-Arg', httpHeaderSafeJson(args))\n      .on('request', function () {\n        if (this.xhr) {\n          this.xhr.responseType = 'blob';\n        }\n      });\n\n    if (selectUser) {\n      apiRequest = apiRequest.set('Dropbox-API-Select-User', selectUser);\n    }\n\n    // Apply the node binary parser to the response if executing in node\n    if (typeof window === 'undefined') {\n      apiRequest\n        .buffer(true)\n        .parse(nodeBinaryParser)\n        .end(responseHandler);\n    } else {\n      apiRequest.end(responseHandler);\n    }\n  };\n\n  return new Promise(promiseFunction);\n};\n\nmodule.exports = downloadRequest;\n"},"hash":"024e90a79e2a3e382428535ef5442218"}